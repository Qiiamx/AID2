# 明日方舟同人游戏赛事网站 - 项目理解指南

## 📋 项目概述

这是一个基于明日方舟游戏开发的同人游戏赛事网站，实现了多人实时博弈对战系统。玩家分为两队，通过博弈机制获取干员，最终完成比赛。

## 🛠️ 技术栈

### 前端
- **框架**: Vue 3 + Vite
- **状态管理**: Pinia
- **路由**: Vue Router
- **实时通信**: WebSocket

### 后端
- **运行环境**: Node.js
- **WebSocket**: ws 库
- **HTTP**: 原生 Node.js HTTP 模块

## 📁 项目结构

```
lxby/
├── service/              # 后端服务
│   └── service.js        # 核心后端逻辑（WebSocket服务器、游戏状态管理）
├── ui/                   # 前端应用
│   ├── src/
│   │   ├── pages/        # 页面组件
│   │   ├── components/    # 通用组件
│   │   ├── stores/       # Pinia状态管理
│   │   ├── router/        # 路由配置
│   │   ├── utils/        # 工具函数
│   │   └── assets/       # 静态资源（干员数据、分支数据）
│   └── public/           # 公共资源（图片、图标）
└── docker-compose.yml    # Docker部署配置
```

## 🎮 核心业务逻辑

### 游戏阶段流程

1. **开局阶段 (OPENING)**
   - 抽取3名开局干员
   - 展示给所有玩家
   - 倒计时后进入等待阶段

2. **等待阶段 (WAITING)**
   - 主持人可以开始博弈
   - 选手可以终止（仅在博弈回合内）

3. **博弈阶段 (BIDDING)**
   - 抽取1名干员进行博弈
   - 双方选择：休息/博弈抓取/终止
   - 25秒倒计时
   - 结算：获胜方获得干员，失败方扣除CP或恢复资源

4. **终止状态处理**
   - 一方终止：进入单边模式（从下一回合开始生效）
   - 双方终止：进入等待阶段，等待主持人重新开局/重新开始博弈

### 关键机制

- **禁用池 (Ban Pool)**: 平局时禁用干员及其分支，重新开局/重新开始博弈时将所有干员加入禁用池
- **单边模式**: 一方终止后，未终止方只能出价10点或终止
- **资源管理**: CP（调用点）、IP（情报点）
- **终止状态**: 终止后本回合不视作休息，资源不变

## 📄 必须查看的核心文件

### 🔴 优先级1：核心业务逻辑（必须理解）

#### 后端核心
1. **`service/service.js`** (2690行)
   - **重要性**: ⭐⭐⭐⭐⭐
   - **内容**: 
     - WebSocket服务器实现
     - 游戏状态管理（gameStates）
     - 所有游戏阶段逻辑
     - 博弈结算逻辑（`resolveBiddingRound`）
     - 终止状态处理
     - 单边模式逻辑
     - 禁用池管理
     - 重新开局/重新开始博弈逻辑
   - **关键函数**:
     - `resolveBiddingRound()`: 博弈回合结算（行600-1000）
     - `drawOpeningOperators()`: 抽取开局干员（行194-268）
     - `drawOneOperator()`: 抽取博弈干员（行270-360）
     - 终止处理逻辑（行1639-1770）
     - 重新开局逻辑（行2078-2218）
     - 重新开始博弈逻辑（行2220-2364）

#### 前端核心
2. **`ui/src/pages/MatchPage.vue`** (1585行)
   - **重要性**: ⭐⭐⭐⭐⭐
   - **内容**:
     - 主游戏界面
     - WebSocket消息处理
     - 游戏状态同步
     - 所有游戏阶段的UI控制
   - **关键部分**:
     - WebSocket消息监听（行700-950）
     - 终止状态处理（行903-939）
     - 游戏阶段切换逻辑

3. **`ui/src/components/BattleControlButtons.vue`** (764行)
   - **重要性**: ⭐⭐⭐⭐⭐
   - **内容**:
     - 主持人操作按钮（开局、开始博弈、重新开局、重新开始博弈）
     - 选手操作按钮（休息、博弈抓取、终止）
     - 单边模式UI控制
   - **关键逻辑**:
     - 按钮显示/禁用条件（行28-63, 98-149）
     - 单边模式按钮禁用（行104, 122, 132）

### 🟡 优先级2：重要组件和页面

4. **`ui/src/pages/hello-page.vue`**
   - 角色选择页面
   - 用户注册（昵称、头像、代号）
   - 邀请链接生成

5. **`ui/src/pages/Lobby.vue`**
   - 大厅页面
   - 显示所有连接的玩家
   - 主持人控制（开始倒计时、开始比赛）

6. **`ui/src/components/BattleSidePanel.vue`**
   - 队伍信息面板
   - 显示干员列表、资源（CP/IP）
   - 终止状态显示

7. **`ui/src/components/BattleCenterConsole.vue`**
   - 中心控制台
   - 开局展示动画
   - 博弈阶段显示

8. **`ui/src/components/BattleBanPool.vue`**
   - 禁用池显示组件
   - 显示被禁用的干员及其分支

9. **`ui/src/components/BattlePublicPool.vue`**
   - 公共牌区显示
   - 开局干员展示

10. **`ui/src/stores/match.js`** (454行)
    - Pinia状态管理
    - WebSocket连接管理
    - 消息广播机制

### 🟢 优先级3：数据文件和工具

11. **`ui/src/assets/operators.json`**
    - 所有干员数据（400名干员）
    - 包含：干员名、稀有度、职业、分支等

12. **`ui/src/assets/branches.json`**
    - 所有分支数据（70个分支）
    - 包含：分支名、所属职业

13. **`ui/src/utils/operators.js`**
    - 干员数据工具函数
    - 筛选、查找、格式化干员数据

14. **`ui/src/router/index.js`**
    - 路由配置
    - 页面跳转逻辑

## 🔍 理解顺序建议

### 第一步：理解项目整体架构
1. 阅读本指南（项目理解指南.md）
2. 查看 `ui/src/router/index.js` 了解页面结构
3. 查看 `ui/src/stores/match.js` 了解状态管理

### 第二步：理解数据模型
1. 查看 `ui/src/assets/operators.json` 了解干员数据结构
2. 查看 `ui/src/assets/branches.json` 了解分支数据结构
3. 查看 `ui/src/utils/operators.js` 了解数据工具函数

### 第三步：理解游戏流程
1. 阅读 `service/service.js` 的以下部分：
   - 游戏状态初始化（行270-360）
   - 开局阶段逻辑（行914-1006）
   - 博弈阶段逻辑（行1200-1400）
   - 结算逻辑（行600-1000）
   - 终止状态处理（行1639-1770）

2. 阅读 `ui/src/pages/MatchPage.vue` 的以下部分：
   - WebSocket消息处理（行700-950）
   - 游戏阶段切换（行709, 732, 878, 932）

### 第四步：理解UI组件
1. `ui/src/pages/hello-page.vue` - 入口页面
2. `ui/src/pages/Lobby.vue` - 大厅页面
3. `ui/src/pages/MatchPage.vue` - 主游戏页面
4. `ui/src/components/BattleControlButtons.vue` - 操作按钮
5. `ui/src/components/BattleSidePanel.vue` - 队伍信息面板
6. `ui/src/components/BattleCenterConsole.vue` - 中心控制台

## 🎯 关键概念说明

### 游戏阶段 (gamePhase)
- `OPENING`: 开局阶段
- `OPENING_SHOW`: 开局展示阶段
- `WAITING`: 等待阶段
- `BIDDING`: 博弈阶段
- `BIDDING_ANIMATION`: 博弈动画阶段

### 用户角色 (role)
- `HOST`: 主持人
- `TEAM_A`: 队伍A选手
- `TEAM_B`: 队伍B选手
- `SPECTATOR`: 观众

### 终止状态
- `teamATerminated`: A队是否已终止
- `teamBTerminated`: B队是否已终止
- `teamATerminatedRound`: A队终止时的回合数（用于判断单边模式）
- `teamBTerminatedRound`: B队终止时的回合数（用于判断单边模式）

### 单边模式
- **生效时机**: 从下一回合开始生效（不是当前回合）
- **限制**: 未终止方只能出价10点或终止，不能休息
- **判断条件**: `teamATerminatedRound < currentRound` 或 `teamBTerminatedRound < currentRound`

### 禁用池 (Ban Pool)
- `bannedMap`: 按分支组织的禁用干员映射（用于前端显示）
- `bannedBranches`: 禁用的分支集合（用于抽卡过滤）
- `takenOperators`: 已占用的干员名称集合（防止重复抽取）

### 资源管理
- `CP` (调用点): 用于博弈抓取，初始50点
- `IP` (情报点): 用于解锁干员信息，初始1点

## 📝 重要修改历史（供参考）

### 已删除的功能
- **攻略准备阶段**: 已完全移除（`STRATEGY_PREP`, `STRATEGY_TRANSITION`, `STRATEGY_COMPLETED`）

### 关键逻辑修改
1. **终止按钮位置**: 从等待阶段移到博弈阶段
2. **单边模式生效时机**: 从下一回合开始生效（不是当前回合）
3. **双方终止处理**: 干员返回池子，立即进入等待阶段
4. **禁用池逻辑**: 重新开局/重新开始博弈时，将所有干员加入禁用池
5. **颜色交换**: Team A = 蓝色，Team B = 红色
6. **文本顺序**: 所有显示改为"中文 // 英文"

## 🔗 WebSocket消息类型

### 客户端 → 服务器
- `join_lobby`: 加入大厅
- `update_profile`: 更新个人信息
- `start_countdown`: 开始倒计时
- `start_match`: 开始比赛
- `start_bidding`: 开始博弈
- `bid`: 博弈抓取
- `rest`: 休息
- `terminate`: 终止
- `buy_intel`: 购买情报
- `restart_game`: 重新开局
- `restart_bidding`: 重新开始博弈

### 服务器 → 客户端
- `update_lobby`: 大厅更新
- `opening_start`: 开局开始
- `opening_countdown`: 开局倒计时
- `bidding_start`: 博弈开始
- `bidding_resolve`: 博弈结算
- `bidding_waiting`: 回到等待阶段
- `termination_update`: 终止状态更新
- `all_terminated`: 双方都终止
- `ban_pool_update`: 禁用池更新
- `game_reset`: 游戏重置

## ⚠️ 注意事项

1. **单边模式判断**: 必须检查终止回合数，确保从下一回合开始生效
2. **双方终止处理**: 必须设置 `gamePhase = 'WAITING'` 并广播 `all_terminated` 消息
3. **禁用池管理**: 禁用池是全局共享的，不会在重新开始时被重置
4. **资源结算**: 终止方本回合不视作休息，资源不变
5. **前端按钮禁用**: 单边模式下，除10档位和终止按钮外，其他选项都应被禁用

## 📚 建议阅读顺序

1. **快速了解**: 本指南 + `ui/src/router/index.js` + `ui/src/stores/match.js`
2. **数据理解**: `ui/src/assets/operators.json` + `ui/src/assets/branches.json` + `ui/src/utils/operators.js`
3. **核心逻辑**: `service/service.js` (重点：行600-1000, 1200-1400, 1639-1770, 2078-2364)
4. **前端实现**: `ui/src/pages/MatchPage.vue` + `ui/src/components/BattleControlButtons.vue`
5. **UI组件**: 其他组件按需查看

## 🎯 关键代码位置速查

| 功能 | 文件 | 行数范围 |
|------|------|----------|
| 博弈结算 | `service/service.js` | 600-1000 |
| 终止处理 | `service/service.js` | 1639-1770 |
| 单边模式判断 | `service/service.js` | 627-656, 673-695 |
| 重新开局 | `service/service.js` | 2078-2218 |
| 重新开始博弈 | `service/service.js` | 2220-2364 |
| WebSocket消息处理 | `ui/src/pages/MatchPage.vue` | 700-950 |
| 按钮控制 | `ui/src/components/BattleControlButtons.vue` | 28-149 |

---

**提示**: 建议先理解整体架构，再深入具体功能模块。遇到问题时，优先查看 `service/service.js` 和 `ui/src/pages/MatchPage.vue` 这两个核心文件。

